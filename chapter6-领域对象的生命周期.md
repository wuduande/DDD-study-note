# 领域对象的生命周期定义

每个对象都有生命周期。创建、使用、存储、重建、删除。一些对象创建、使用
之后就由垃圾回收器回收，其生命周期不需要过多关注。而entity的生命周期
较长。主要挑战如下：

1. 在整个生命周期中维护完整性。

2. 防止模型陷入管理生命周期复杂性造成的困境当中。

本章讲解三种模式：aggregate,factory,repository. aggregate在对象的
存活期间维护对象之间的聚合关系，保证对象的内部一致。factory生产aggregate,
repository存储、重建、删除已存在的aggregate.

# Aggregate

aggregate有一个根。根是一个entity对象。此entity对象是aggregate边界
外部对此aggregate持有的唯一引用。由aggregate根持有aggregate内部对象
的引用。内部对象之间可以任意关联。这些关联在aggregate外部不可见。
多个aggregate之间，可以互相关联。

aggregate的特征如下：

1. 根entity具有全局唯一标识。它最终负责检查固定规则（invariant,不变式）。
即一致性。

2. aggregate内的entity具有本地标识。这些标识可以只在边界内部唯一。

3. aggregate外部的对象不可以引用除根以外的任何内部对象。以避免外部更改
导致不变性（invariant）受到影响。

4. 只有aggregate的根才可以通过数据库查询找到。其它对象必须通过关联的
遍历才可以找到。外部对象只能临时持有内部对象。

5. aggregate内部的对象可以保持对其它aggregate根的关联。

6. 删除操作必须一次性删除aggregate边界内的所有对象。

7. aggregate边界的任何改变都必须受到不变性（invariant）的约束。

注意：在更新entity时，通常我们的考虑，都是将最后提交的版本更新到数据库
就好了。没有考虑过一个问题：如果两个人同时取得entity的同一个版本，然后
并行修改。提交时，后提交者的版本，是在先提交者之前的版本上修改的。如果
用后提交的替换先提交的版本，则先提交者的修改就白费了。这个问题之所以不
严重，是因为我们的业务还没有涉及到这个问题。对于简单的修改和更新，都是
直接update,或者increase，而非基于之前版本修改，从而避免这个问题。
但在wiki,jira,git这样的软件中，更改的冲突问题就非常明显了。

# Factory

封装构造复杂Aggregate的知识。使得使用aggregate的用户不会知识过载。

“司机不必知道车的生产过程”

**好工厂的要求：**

1. 每个创建方法都是原子方法。被创建aggregate必须满足不变式。无法成功
创建时，应当终止创建，而不可以返回不合法状态的aggregate.

2. 不生产具体的类。生产抽象。

工厂可以是独立的工厂类。也可以由一些聚合根的工厂方法来实现，如果此聚合
根持有了大量的构建所需要的信息，以及领域概念上的生产关系。

**工厂产品的不变性**有两个去处：

1. aggregate内部。可以避免aggregate根内部的混乱。但如果此不变性
规则在aggregate的生命中周期中会不断使用，则应该放在aggregate中。

2. 工厂中。这样可以使用aggregate的逻辑变得简单。这对于value对象
来说非常合适。value自构造完成之后再也不会发生变化，因此没有必要持有
自己永远不会用到的校验知识。

**对象重建**

对象被存储到数据库、经过网络传输后，需要重建。重建对象的工厂与创建工厂
的区别：

1. 不为entity重新分配ID

2. 重建时，不变式可能已经不能满足。比如：时间属性随着时间的变化可能已经
不能满足创建时的不变式约束。

# Repository

客户要获取领域对象的引用，不可越过repository. 否则将引入过多可遍历的关联。
造成模型混乱。客户要获取对象，必须从repository 获取 aggregate根，然后
从aggregate根导航得到。避免领域知识泄漏到外部。All you should know
is aggregate. 这种风险通常来自对数据库的直接查询，领域模型被越过了。

在所有持久的对象中，只有一小部分需要基于其属性的搜索来全局访问。它们通常是
entity.有时是复杂结构的value，或者是枚举。其余的通过关联的遍历来访问。
直接通过基础设置和数据库来访问这些数据将妨碍DDD.

repository屏蔽了底层基础设施和数据库的映射操作。从而保证**领域模型中的代码
都反映了业务操作，与技术无关。**

Repository必须满足上层的查询需求。否则将被弃之不用。



